name: CI/CD with Minikube for BankingSystem

on:
  pull_request:
  push:
    branches: [main]

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    name: Build & Deploy BankingSystem on Minikube

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: ğŸš€ Start Minikube
        uses: medyagh/setup-minikube@latest
        with:
          start: true
          cache: true
          minikube-version: latest
          wait: all

      - name: ğŸ› ï¸ Build project with Maven
        run: mvn clean package
        working-directory: Bankingsystem-main/BankingSystem

      - name: ğŸ³ Build Docker image inside Minikube
        run: |
          minikube image build -t local/banking-system:latest Bankingsystem-main/BankingSystem

      - name: ğŸ“¦ Deploy to Minikube
        run: |
          kubectl apply -f Bankingsystem-main/BankingSystem/Deployment.yaml
          kubectl get pods
          kubectl wait --for=condition=ready pod -l app=banking-system --timeout=180s

      - name: ğŸ” Show app logs (for debugging)
        run: |
          kubectl logs -l app=banking-system --all-containers=true

      - name: ğŸŒ Test Service
        run: |
          echo "Service URL:"
          minikube service banking-system-svc --url
          echo "Trying curl:"
          curl $(minikube service banking-system-svc --url) || echo "âŒ Service may not be ready"

      - name: âœ… Done
        run: echo "âœ… BankingSystem deployed!"
